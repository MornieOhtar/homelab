apiVersion: ceph.rook.io/v1
kind: CephObjectStoreUser
metadata:
  name: k8up
  namespace: rook-ceph
spec:
  store: backup-ssd
  displayName: "k8up s3 user"
  keys:
    - accessKeyRef:
        key: ACCESS_KEY_ID
        name: k8up-local-s3
      secretKeyRef:
        key: ACCESS_SECRET_KEY
        name: k8up-local-s3
---
apiVersion: objectbucket.io/v1alpha1
kind: ObjectBucketClaim
metadata:
  name: k8up
  namespace: rook-ceph
spec:
  bucketName: k8up
  storageClassName: rook-ceph-backup-ssd-bucket
  additionalConfig:
    bucketOwner: "k8up"
---
apiVersion: v1
kind: Secret
metadata:
  name: k8up-local-s3
  namespace: rook-ceph
  annotations:
    replicator.v1.mittwald.de/replicate-to: "backend,dev-env,home,operators"
    avp.kubernetes.io/path: "kv/data/argocd"
type: Opaque
data:
  ACCESS_KEY_ID: <K8UP_MINIO_KEY_ID | base64encode>
  ACCESS_SECRET_KEY: <K8UP_MINIO_SECRET | base64encode>
---
apiVersion: v1
kind: Secret
metadata:
  name: k8up-remote-s3
  annotations:
    avp.kubernetes.io/path: "kv/data/argocd"
type: Opaque
data:
  REMOTE_ACCESS_KEY_ID: <K8UP_REMOTE_KEY_ID | base64encode>
  REMOTE_ACCESS_SECRET_KEY: <K8UP_REMOTE_SECRET | base64encode>
  REMOTE_HOST: <K8UP_REMOTE_HOST | base64encode>
  REMOTE_BUCKET: <K8UP_REMOTE_BUCKET | base64encode>
---
apiVersion: v1
kind: Secret
metadata:
  name: k8up-local-restic
  annotations:
    replicator.v1.mittwald.de/replicate-to: "backend,dev-env,home"
    avp.kubernetes.io/path: "kv/data/argocd"
type: Opaque
data:
  restic-password: <k8up-local-restic>
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: k8up-remote-sync
spec:
  schedule: "0 4 * * *"  # Run daily at 03:00
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: rclone-sync
              image: rclone/rclone:latest
              args:
                - sync
                - "local-s3:k8up"
                - "remote-s3:backups-k8up"
                - "--progress"
                - "--transfers=8"
                - "--checkers=16"
                - "--s3-chunk-size=64M"
                - "--s3-upload-concurrency=4"
                - "--s3-no-check-bucket"
                - "--stats=30s"
              envFrom:
                - secretRef:
                    name: k8up-local-s3
                - secretRef:
                    name: k8up-remote-s3
              volumeMounts:
                - name: rclone-config
                  mountPath: /config
          volumes:
            - name: rclone-config
              emptyDir: {}
          initContainers:
            - name: rclone-config-init
              image: busybox:1.36
              command:
                - sh
                - -c
                - |
                  mkdir -p /config/rclone
                  cat <<EOF > /config/rclone/rclone.conf
                  [local-s3]
                  type = s3
                  provider = Ceph
                  access_key_id = ${ACCESS_KEY_ID}
                  secret_access_key = ${ACCESS_SECRET_KEY}
                  endpoint = http://rook-ceph-rgw-backup-ssd.rook-ceph.svc:80

                  [remote-s3]
                  type = s3
                  provider = B2
                  access_key_id = ${REMOTE_ACCESS_KEY_ID}
                  secret_access_key = ${REMOTE_ACCESS_SECRET_KEY}
                  endpoint = ${REMOTE_HOST}
                  EOF
              envFrom:
                - secretRef:
                    name: k8up-local-s3
                - secretRef:
                    name: k8up-remote-s3
              volumeMounts:
                - name: rclone-config
                  mountPath: /config
